<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>

<link rel="stylesheet" href="/css/admin/banner.css">

<div class="banner-container">
    <div class="page-header">
        <h2>Banners</h2>
    </div>

    <div class="banner-previews">
        <div class="banner-section">
            <h3>Main Banner</h3>
            <div class="banner-item main-banner">
                <img src="<%=main[0].image_url%>" alt="Main Banner" data-img-slot="main-banner">
                <div class="overlay-text">
                    <h2>Not Just A Watch <br> A Legacy</h2>
                    <p>Discover the finest collection of elegant timepieces.</p>
                </div>
                <a href="#" class="action-btn add-btn" data-slot="main-banner" data-aspect-ratio="16/5">
                    <i class="fas fa-plus-circle"></i> Add Main Banner
                </a>
            </div>
        </div>

        <div class="banner-section">
            <h3>Hand picked Banners</h3>
            <div class="banner-grid">
                <div class="banner-item handpicked-item">
                    <span class="banner-label">Slot 1</span>
                    <img src="<%=slot1[0].image_url%>" alt="Hand picked Banner 1" data-img-slot="handpicked-1">
                    <a href="#" class="action-btn add-btn" data-slot="handpicked-1" data-aspect-ratio="3/4">
                        <i class="fas fa-plus-circle"></i> Add
                    </a>
                </div>
                <div class="banner-item handpicked-item">
                    <span class="banner-label">Slot 2</span>
                    <img src="<%=slot2[0].image_url%>" alt="Hand picked Banner 2" data-img-slot="handpicked-2">
                    <a href="#" class="action-btn add-btn" data-slot="handpicked-2" data-aspect-ratio="3/4">
                        <i class="fas fa-plus-circle"></i> Add
                    </a>
                </div>
                 <div class="banner-item handpicked-item">
                    <span class="banner-label">Slot 3</span>
                    <img src="<%=slot3[0].image_url%>" alt="Hand picked Banner 3" data-img-slot="handpicked-3">
                    <a href="#" class="action-btn add-btn" data-slot="handpicked-3" data-aspect-ratio="3/4">
                        <i class="fas fa-plus-circle"></i> Add
                    </a>
                </div>
            </div>
        </div>
        </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    let cropper;
    let currentSlotId;
    let currentAspectRatio;

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    document.querySelector('.banner-container').addEventListener('click', (event) => {
        const addButton = event.target.closest('.add-btn');
        if (!addButton) return;

        event.preventDefault();
        
        currentSlotId = addButton.dataset.slot;
        currentAspectRatio = parseFloat(eval(addButton.dataset.aspectRatio)) || 16 / 9;
        
        fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
        const files = event.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = () => {
                showCropperModal(reader.result);
            };
            reader.readAsDataURL(files[0]);
        }
        event.target.value = ''; 
    });

    function showCropperModal(imageDataUrl) {
        Swal.fire({
            title: 'Crop Your Image',
            html: `<div style="max-height: 50vh;"><img id="cropper-image" src="${imageDataUrl}" style="max-width: 100%;"></div>`,
            confirmButtonText: 'Save Banner',
            showCancelButton: true,
            width: '800px',
             background: '#000', 
            color: '#fff',
            didOpen: () => {
                const image = document.getElementById('cropper-image');
                cropper = new Cropper(image, {
                    aspectRatio: currentAspectRatio,
                    viewMode: 1,
                });
            },
            preConfirm: () => {
                return new Promise((resolve) => {
                    const canvas = cropper.getCroppedCanvas({ width: 1280 })
                    canvas.toBlob((blob) => {
                        if (blob) uploadCroppedImage(blob)
                        resolve()
                    }, 'image/jpeg', 0.9)
                })
            },
            willClose: () => {
                if (cropper) cropper.destroy()
            }
        })
    }

    function uploadCroppedImage(blob) {
        const formData = new FormData()
        formData.append('bannerImage', blob, `${currentSlotId}.jpg`)
        formData.append('slotId', currentSlotId)

        Swal.fire({
            title: 'Uploading...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false
        });

        fetch('/admin/banners/upload', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                });
                
                const imgElement = document.querySelector(`img[data-img-slot="${currentSlotId}"]`)
                if (imgElement) {
                    imgElement.src = `${data.banner.image_url}?t=${new Date().getTime()}`
                }
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Upload Failed',
                text: error.message || 'Something went wrong!',
            })
        })
    }
});
</script>